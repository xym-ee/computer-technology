---
sort: 2
---
# 输入输出设备模型


## 计算机与物理世界的接口


## 总线、中断控制器和DMA

为何程序的 `while(1);` 不会卡死 CPU 呢？因为真的有个线连在了 CPU 上，上古CPU 6502 有个脚 $$ \overline{IRQ} $$ ，所以说操作系统启动就就变成了中断处理程序。

Intel 的中断控制器，8259A，

现在的 CPU 有两个，APIC，IOPIC，
- local APIC: 中断向量表, IPI, 时钟,
- I/O APIC: 其他 I/O 设备


中断没能解决的问题，假设程序希望写入 1GB 数据到磁盘。数据需要总线上绕一圈，这就慢了。搬动数据这种重复的活，

```c
for (int i=0; i<1GB/4; i++)
{
    outl(PORT, ((u32*)buf)[i]);
}
```

几个专门用来执行 memcpy 的CPU ，
- memory → memory
- memory → device (register)
- device (register) → memory

这就是 DMA 控制器，直接连接在总线和内存上。典型的芯片 Intel 8237A。

现在的电脑支持总线 DMA，比如网卡可以直接不经过CPU写内存。写好通知CPU取数据。


## GPU 和异构计算

零个我们非常关心的设备，显卡。

DMA 就是一个 “做一件特别事情” 的 CPU 。

还可以设计其他的特殊使用的 CPU，广泛的讲，打印机也是一个做一件事情的 CPU。我们完全可以在计算机里加 CPU ，做任何事情，显卡就是这么个设备。

大一刚学编程的时候，输出各种字符画。

```c
for (int i = 1; i <= H; i++) {
  for (int j = 1; j <= W; j++)
    putchar(j <= i ? '*' : ' ');
  putchar('\n');
}
```

但是，如果想在4K屏幕上画彩色图形，就不是很容易了。CPU 跟不上显示的速度这个问题由来已久。

早在任天堂 NES 的年代，CPU 是6502 芯片，1.79Mhz，IPC=0.43，不像现在的CPU乱序执行。可是居然做到了在屏幕上显示 256*240=61k像素(256色)。而且60fps显示，非常丝滑，每一帧只给10k调指令，10k条指令执行61k个nop都不行，更别说去总线上搬东西了。这个问题就是如何在有限的CPU运算力下实现60Hz。

当时的聪明工程师，想到了和 DMA 一样的设计，增加一个小 CPU，这个设备只能用来画图，但是画的超级快。这就是 NES 的 Picture Processing Unit(PPU)。

CPU 只描述8*8方块的摆放方法。

如果我们有更多的晶体管，就可以做更复杂的事情。实现上只需要加法和位运算。更强大的计算能力 = 更复杂的图形绘制。

但是现在的 3D 有限，丰富的图形是怎么来的？甚至有光照效果。

全靠 PS，(后处理)，GLSL
- GLSL (Shading Language)
  - 使 “shader program” 可以在 GPU 上执行
  - 可以作用在各个渲染级别上：vertex, fragment, pixel shade
  - 相当于一个 “PS” 程序，算出每个部分的光照变化全局光照、反射、阴影、环境光遮罩……


既然显卡越来越复杂，现代的 GPU 不仅仅可以做这么复杂的光线运算，那么是不是也可以用来做矩阵计算。于是就有了CUDA、有了显卡上的通用计算。

程序保存在内存 (显存) 中
- main 编译/链接成本地可执行的 ELF
- kernel 编译成 GPU 指令 (送给驱动)


GPU就是一个有好多好多CPU 的系统比如 4096CPU，CPU把GPU需要的数据通过 DMA 送到显存里，然后把 code 也送到显存里。然后就可以执行了，执行完给CPU发个中断。

GPU 既可以看成 IO 设备，也可以看成另一台计算机。如果是玩游戏的话，GPU还会把像素算出来，推给视频接口。

通用计算的例子，PyTorch 和炼丹炉。

什么是深度神经网络？

逻辑不难，代码不多，的重复运算。难点在于参数特别多。

到今天，Dark Silicon Age 和异构计算，功耗成为了瓶颈。能完成 “同一件事” 的部件可能有很多，要选择功耗/性能/时间最合适的那个！事实上 GPU 跑神经网络能效比都很低，用NPU。

如果将来狂潮来了，手机上的 SoC，可以集成 CPU,GPU,NPU,矿PU，，一个SoC的功耗就这么大，来任务以后选择能效比最高的来计算。


## 总结

从uart到GPU。

IO设备就是一组交换数据的接口和协议。

如果你 “自己造一台计算机”，你会发现这一切都是自然的。

“不容易理解” 的部分是随时间积累的复杂性。

一个完整的计算机系统，NES 6502.


