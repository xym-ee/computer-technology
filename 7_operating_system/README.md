---
sort: 7
---
# 操作系统导论


## 2023-05-05 关于并发

单核并发广泛的用在 RTOS 中，因此一些桌面现代处理器的问题在 MCU 上跑 RTOS 时可能不会遇到。要理解并发存在的问题，先要玩玩并发程序，建立起每个 CPU 都可以执行一个函数(线程)的初步思想。然后再看看经典的例子，多线程对一个技术变量做累加会出现的问题，这就发现了现代多处理器并发编程的问题。

为了解决并发问题，早期首先在裸机(或者现在的纯用户层)尝试一些简单的基于标志变量的纯程序的方法，比如 Peterson 算法，当时可能可行但是在现在的多处理器上都失效了。在硬件的努力下，我们有了原子指令，使得并发问题有了更直观、代码实现更简单的实现：自旋锁。

自旋锁只能说是可以解决这个问题(裸机和用户层都行)，但是不够好，对于单核处理器来说，自旋就啥也干不了了，对于多核处理器来说，自旋时 CPU 空转也是很浪费的，因此，我们想让线程在等待时让出 CPU ，这就有了互斥锁。操作系统为引用层的线程提供互斥锁，操作系统内部则可以使用自旋锁实现互斥。

并发的两大需求是**互斥**(保护共享数据)和**等待**(线程间依赖)，互斥用自旋锁提高效率了，但是等待这个过程还是轮询的，把等待的轮询也让出 CPU ，这就有了条件变量。

一个更优雅的方案是信号量，实现这是互斥与等待的一体化。




## 2023-03-12

2021 年我粗略了看了哈工大的操作系统课，源码讲解的章节都跳过了，当时我只有微机原理的基本知识，以及做过 MCU 裸机开发，底层硬件接触的比较多。

2022 年 4 月份，我开始在 MCU 上使用嵌入式实时操作系统，rtthread，学会了基本接口的使用，也模糊的有了一些操作系统的概念。

2022 年年底到 2023 年初，过年寒假期间，我开始学习南京大学 jyy 老师的操作系统课，到目前为止，也只是跳着看了看，第一遍粗略的学习，刚好现在 jyy 老师开始了新一学年的操作系统课，我也跟着学习第二遍，在这个时间点，记录一下对操作系统的理解。

操作系统首先要考虑的问题，并发，即多任务同时执行。这也是上古时期压榨 CPU 性能最先考虑的问题，现在 mcu 基本上都是单核多线程并发还是相对容易一些，在多核多线程的情况下，并发有各种意想不到的问题，为了写出正确的并发程序，操作系统设计了锁、信号量等机制，使得CPU能充分被使用。

对一个程序来讲，自己占有整个 PC 是最舒服的状态，也是容易使用的状态。虚拟化就在做这个事情，为每个程序（进程）虚拟出自己的空间。各个程序互不打扰，各管各的，最典型的，每个进程都有自己的地址空间，这个设计依赖硬件上的 MMU，因此 MCU 上的 RTOS 并没有这层机制。

上面的东西，运行的数据都是在 RAM 里，断电会丢失，因此还要考虑数据持久化保存的问题。类似的理解：程序和进程的区别。为了让数据持久化保存，以及更好的管理数据，设计了文件系统，以及一系列 api，对磁盘的使用实际上就是对一组寄存器的读写，为了容易的使用，就有了封装寄存器的程序，即设备驱动。


## 参考资料

操作系统：设计与实现(南京大学)

- [jyy的主页Yanyan's Wiki](http://jyywiki.cn/)
- [课程主页 2023 春季学期](http://jyywiki.cn/OS/2023)
- [课程视频 2023 春季学期](https://www.bilibili.com/video/BV1Xx4y1V7JZ)
- [课程主页 2022 春季学期](http://jyywiki.cn/OS/2022)
- [课程视频 2022 春季学期](https://www.bilibili.com/video/BV1Cm4y1d7Ur)



